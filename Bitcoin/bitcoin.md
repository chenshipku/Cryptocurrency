# 比特币运行机制

此文参照视频 [How Bitcoin Works Under the Hood](https://www.youtube.com/watch?v=Lx9zgZCMqXE).

## 什么是比特币

比特币是一个去中心化的账本存储系统。账本中记录了所有比特币转账信息，所有加入比特币网络的电脑上，都会存储一份这样的账本。
由于去中心化储存的特点，当某一个节点处理了一笔转账之后，需要将处理的情况广播给临近的其他节点，直至网络上所有节点的账本信息都被更新。

## 交易授权

我们使用密码或者签名来对银行卡交易进行授权。比特币利用公钥+私钥进行授权，其中公钥相当于公开的收款账号，秘钥则相当于密码。
比特币系统让每个参与交易的人，先随机生成一个字符串作为私钥，然后通过私钥生成唯一对应的公钥。由于非对称加密的特点，人们无法通过公钥推知私钥信息。
当Alice给Bob转5个BTC时，会使用Alice的私钥解锁她的5个BTC，然后用Bob的公钥将其锁定。之后这5个BTC便只能通过Bob的私钥才能解锁转移。
具体到比特币交易的数据结构，包括：
* inputs:

  * txn1：标记1，与涉及这笔比特币的上次交易的标记2相同。通过txn**可追溯**到这笔比特币的流通历史。

  * ScriptSig：Alice私钥的Hash值，用于解锁。

* outputs:

  * txn2：标记2，与涉及这笔比特币的下次交易的标记1相同。

  * Amount：金额

  * ScriptPubKey：用Bob公钥生成的锁定脚本

Alice使用比特币时，比特币系统会先通过txn1找到涉及这笔比特币的上次交易，作两个验证，
一是验证上次交易的ScriptPubKey与这次交易的ScriptSig是否相匹配，二是验证这次交易的input是否在未被支付交易的索引中。
这两项验证之后，Alice才可以使用这笔比特币。
以上只是最简单的情况，实际上可能Alice使用的5个比特币来源于之前的两笔交易，那么inputs里面就有txn11,txn12。

## 篡改交易

比特币系统中只有如上所述的交易记录，每个账户（公钥）名下的余额是将这个公钥下的所有转入转出加和得到。所以要篡改余额，需要篡改交易。
比特币系统的交易数据存储方式是区块链。交易发生后先在计算机内存中进行验证，验证通过后会作为未确认交易放在有效交易池中等待被装到区块里。
矿工节点从有效交易池中抽取千笔左右未确认交易进行打包，并加上一个Nounce变量以及上一个区块的Hash值，求这个区块的Hash值，产生新的区块。
由此可见每一个区块的Hash值与上一个区块的Hash值有关，若是篡改历史交易，那么该笔交易之后所有的数据记录都会出现不匹配的情况。要调整后面所有的数据使它们匹配起来几乎是不可能的任务。

## 双花攻击与工作量证明

双花攻击指的是Alice给Bob转账（交易1）的同时又发起了一笔给自己地址的转账（交易2）。交易进行广播时，一部分节点先收到交易1的消息，将交易1放入自己的有效交易池中，一部分先收到交易2的消息，将交易2放入自己的有效交易池，于是形成了1,2两个阵营。两个阵营组装的区块不同，相应的区块链也就分叉为两条链。按照比特币的运行规则，以最长的链为准。两个阵营都尝试在自己链条末端增加新的区块。加入阵营2中的某节点发现了新的区块，该节点开始新一轮广播。广播到阵营2的节点时，节点很乐意在链条末端加上新的区块，而广播到阵营1的节点时，由于新的链更长，所以节点会抛弃含有交易1的区块，接上含有交易2的区块以及新的区块，交易1回到内存之后也进不了有效交易池，被认为是一笔无效交易而被遗弃。

为了限制Alice能够轻易造出更长的链条，防止出现Bob发了货却没收到钱的双花攻击，比特币引入了**工作量证明(Proof of Work, POW)。** 
前面提到，每个区块的Hash值由前一个区块的Hash值+一堆交易+Nounce变量这三项计算得到。节点组包时通过调整Nounce值，使得计算出的Hash值小于目标值，这时才可发起一次全网记账动作。比特币系统中，目标值一般是一个由多个0开头的16位数字，每个节点需要进行以亿计次的计算才可以找到满足条件的Hash值。比特币系统会通过调整目标值，确保基本每10分钟可以解出一次Hash。当矿工节点解出Hash值，发起全网记账之后，会被奖励一定数量的比特币。比特币其实就是以对矿工节点记账奖励的形式发行，每四年减半一次，总量为2100万。奖励的比特币也是一笔交易，只是这笔交易没有inputs，只有outputs，outputs里记录的是矿工节点上登记的公钥地址。

回到Alice的双花攻击，由于Alice只有一个节点，算力远小于其他节点之和，所以不可能迅速形成一条更长的链，只有当她控制了全世界多于一半的节点时，她才有可能制造出更长链条，完成双花攻击(51%攻击)。



